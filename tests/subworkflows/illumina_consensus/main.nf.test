nextflow_workflow {

    name "Test of Illumina Consensus Subworkflow with Optional Params"
    script "subworkflows/local/illumina_consensus/main.nf"
    workflow "ILLUMINA_CONSENSUS"
    tag "subworkflows"
    tag "consensus"
    tag "illumina"

    test("Illumina Consensus Workflow with Optional Remove Duplicates Param") {
        tag "success"
        when {
            workflow {
                """
                input[0] = Channel.of(
                        [
                            [id: "MH356245.1"],
                            file("$baseDir/assets/reference/D8/MH356245.1.reference.fasta")
                        ]
                    )
                input[1] = Channel.of(
                        [
                            [id: "MH356245.1"],
                            file("$baseDir/test_data/MH356245.1.reference.fasta.fai")
                        ]
                    )
                input[2] = Channel.of(
                        [
                            [id: "SRR7517490", single_end: false, ref_id: "MH356245.1"],
                            [
                                file("$baseDir/test_data/illumina_fastqs/SRR7517490_R1.fastq.gz"),
                                file("$baseDir/test_data/illumina_fastqs/SRR7517490_R2.fastq.gz")
                            ]
                        ]
                    )
                input[3] = Channel.of(
                        [
                            [id: "MH356245.1"],
                            file("$baseDir/assets/reference/D8/primers.bed")
                        ]
                    )
                """
            }
            params {
                outdir = "results"
                platform = "illumina"
                primer_bed = "$baseDir/assets/reference/D8/primers.bed"
                remove_duplicates = true
            }
        }
        then {
            assertAll(
                { assert workflow.success }
            )

            // Files exist
            // Fastp
            assert path("${launchDir}/results/fastp/SRR7517490.fastp.json").exists()
            // BAM
            assert path("${launchDir}/results/bam/ivar/SRR7517490.primertrimmed.sorted.bam").exists()
            assert path("${launchDir}/results/bam/ivar/SRR7517490.primertrimmed.sorted.bam.bai").exists()
            assert path("${launchDir}/results/bam/picard/SRR7517490.markduplicate.sorted.bam").exists()
            assert path("${launchDir}/results/bam/picard/SRR7517490.markduplicate.sorted.MarkDuplicates.metrics.txt").exists()
            // VCF
            assert path("${launchDir}/results/vcf/processed_vcf/SRR7517490.ambiguous.norm.vcf.gz").exists()
            assert path("${launchDir}/results/vcf/processed_vcf/SRR7517490.consensus.norm.vcf.gz").exists()
            assert path("${launchDir}/results/vcf/processed_vcf/SRR7517490.consensus.tsv").exists()
            assert path("${launchDir}/results/vcf/processed_vcf/SRR7517490.processed.norm.vcf.gz").exists()

            // Consensus md5 --> If it matches, all variants were the same so intermediate files SHOULD be ok/the same
            //  Adjustment for 0.5.0 to use different primers so slight changes
            assert path("${launchDir}/results/consensus/SRR7517490.consensus.fasta").md5 == "0010cc054285afabcc6c5acd5a8c573e"
        }
    }
}
