// Main Tests File
nextflow_pipeline {

    name "Full Pipeline NF-Tests for MeaSeq"
    script "main.nf"

    //--- Test 1 ----------------------------------------------------------------------------
    test("No platform specified") {
        tag "fail"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/test_data/MH356245.1.reference.fasta"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stderr.contains("* Missing required parameter: --platform")
        }
    }

    //--- Test 2 ----------------------------------------------------------------------------
    test("No Input Specified") {
        tag "fail"

        when {
            params {
                platform    = "illumina"
                outdir      = "results"
                reference   = "${projectDir}/test_data/MH356245.1.reference.fasta"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stderr.contains("* Missing required parameter: --input")
        }
    }

    //--- Test 3 ----------------------------------------------------------------------------
    test("Missing Samplesheet Data") {
        tag "fail"

        when {
            params {
                input       = "$baseDir/test_data/missing.csv"
                platform    = "illumina"
                outdir      = "results"
                reference   = "${projectDir}/test_data/MH356245.1.reference.fasta"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stdout.contains("ERROR ~ ERROR: Validation of 'input' file failed!")
        }
    }

    //--- Test 4 ----------------------------------------------------------------------------
    test("Illumina Amplicon Data with Sample Name Completion") {
        tag "success"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/test_data/MH356245.1.reference.fasta"
                platform    = "illumina"
                primer_bed  = "${projectDir}/test_data/primer.bed"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("empty,NA,No Data,2,0,15894,0.0,0.0,0.0,0,")
            assert lines.contains("sample1,D8,Novel-bcb39a9,40476,38478,224,98.59,344.41,309.0,269,")
            assert lines.contains("sample2,D8,Novel-bcb39a9,56368,53533,233,98.53,479.22,477.0,273,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/amplicon.bed").exists()

            lines = path("$launchDir/results/reference/amplicon.bed").text
            assert lines.contains("MH356245.1\t25\t8200\tMSV_1\t1\t+")
            assert lines.contains("MH356245.1\t8025\t15865\tMSV_2\t2\t+")

            assert path("$launchDir/results/reference/genome.bed").exists()

            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 1

            assert path("$launchDir/results/consensus/empty.consensus.fasta").md5 == "c14c11443f08b9976164ed80339150ca"
            lines = path("$launchDir/results/consensus/empty.consensus.fasta").readLines()
            assert lines.contains(">empty MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/empty.N450.fasta").md5 == "d41d8cd98f00b204e9800998ecf8427e"

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "d7450179ac96cfda3e004a7bb74ea2fd"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "49dad01767d044fc73d87a6818765410"

            assert path("$launchDir/results/consensus/sample2.consensus.fasta").md5 == "fcba2244d3181d683411d99a8ace7ba2"
            lines = path("$launchDir/results/consensus/sample2.consensus.fasta").readLines()
            assert lines.contains(">sample2 MH356245.1")
            assert lines.contains("ACCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample2.N450.fasta").md5 == "896c7f643c3fdd5af4f0b4c8195a01df"

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 3

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/Amplicon-Summary-MultiQC-Report_multiqc_report.html").exists()
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "Amplicon-Summary-MultiQC-Report_multiqc_report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "vcf/processed_vcf/sample1.processed.norm.vcf.gz" }.size() == 1

            assert iridanext_metadata.add_sample1.genotype == "D8"
            assert iridanext_metadata.add_sample1.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample1.num_input_reads == "40476"
            assert iridanext_metadata.add_sample1.num_aligned_reads == "38478"
            assert iridanext_metadata.add_sample1.num_consensus_n == "224"
            assert iridanext_metadata.add_sample1.genome_completeness_percent == "98.59"
            assert iridanext_metadata.add_sample1.mean_sequencing_depth == "344.41"
            assert iridanext_metadata.add_sample1.median_sequencing_depth == "309.0"
            assert iridanext_metadata.add_sample1.total_variants == "269"
            assert iridanext_metadata.add_sample1.num_snps == "269"
            assert iridanext_metadata.add_sample1.num_iupac == "0"
            assert iridanext_metadata.add_sample1.genome_length == "15894"
            assert iridanext_metadata.add_sample1.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample1.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample1.N450_mean_depth == "309.74"
            assert iridanext_metadata.add_sample1.N450_status == "PASS"
            assert iridanext_metadata.add_sample1.qc_status == "PASS"
            assert iridanext_metadata.add_sample1.pipeline_version == "0.4.3"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
            assert path("$launchDir/results/pipeline_info/bco.json").exists()
        }
    }

    //--- Test 5 ----------------------------------------------------------------------------
    test("Nanopore NON-Amplicon Data Completion") {
        tag "success"

        when {
            params {
                input       = "${projectDir}/test_data/nanopore_samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/test_data/MH356245.1.reference.fasta"
                platform    = "nanopore"
                model       = "r1041_e82_400bps_sup_v420"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("sample1,D8,Novel-65d31ec,9368,9364,4,99.97,379.37,239.0,273,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/genome.bed").exists()

            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 1

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "38e34a10a458f25afc1a0dcbc9673967"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NCCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266

            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "034fe45b9902229f414548b052dda631"
            lines = path("$launchDir/results/consensus/sample1.N450.fasta").readLines()
            assert lines.contains(">sample1-N450 MH356245.1")
            assert lines.size() == 1

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 2

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "vcf/final/sample1.pass.norm.vcf.gz" }.size() == 1

            assert iridanext_metadata.sample1.genotype == "D8"
            assert iridanext_metadata.sample1.matched_dsid == "Novel-65d31ec"
            assert iridanext_metadata.sample1.num_input_reads == "9368"
            assert iridanext_metadata.sample1.num_aligned_reads == "9364"
            assert iridanext_metadata.sample1.num_consensus_n == "4"
            assert iridanext_metadata.sample1.genome_completeness_percent == "99.97"
            assert iridanext_metadata.sample1.mean_sequencing_depth == "379.37"
            assert iridanext_metadata.sample1.median_sequencing_depth == "239.0"
            assert iridanext_metadata.sample1.total_variants == "273"
            assert iridanext_metadata.sample1.num_snps == "273"
            assert iridanext_metadata.sample1.num_iupac == "0"
            assert iridanext_metadata.sample1.genome_length == "15894"
            assert iridanext_metadata.sample1.divisible_by_6 == "True"
            assert iridanext_metadata.sample1.N450_completeness == "100.0"
            assert iridanext_metadata.sample1.N450_mean_depth == "218.38"
            assert iridanext_metadata.sample1.N450_status == "PASS"
            assert iridanext_metadata.sample1.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
            assert path("$launchDir/results/pipeline_info/bco.json").exists()
        }
    }
}
