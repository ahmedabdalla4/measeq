// Main Tests File
nextflow_pipeline {

    name "Full Pipeline NF-Tests for MeaSeq"
    script "main.nf"

    //--- Test 1 ----------------------------------------------------------------------------
    test("No platform specified") {
        tag "fail"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stderr.contains("* Missing required parameter: --platform")
        }
    }

    //--- Test 2 ----------------------------------------------------------------------------
    test("No Input Specified") {
        tag "fail"

        when {
            params {
                platform    = "illumina"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stderr.contains("* Missing required parameter: --input")
        }
    }

    //--- Test 3 ----------------------------------------------------------------------------
    test("Missing Samplesheet Data") {
        tag "fail"

        when {
            params {
                input       = "$baseDir/test_data/missing.csv"
                platform    = "illumina"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stdout.contains("ERROR ~ ERROR: Validation of 'input' file failed!")
        }
    }

    //--- Test 4 ----------------------------------------------------------------------------
    test("Specifying Amplicon Data without Primers File") {
        tag "fail"

        when {
            params {
                input       = "$baseDir/test_data/nanopore_samplesheet.csv"
                platform    = "nanopore"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
                amplicon    = true
            }
        }
        then {
            // Status
            assert workflow.failed

            // Message
            assert workflow.stdout.contains("Please provide a file with primers using '--primer_bed' when running with '--amplicon'")
        }
    }

    //--- Test 5 ----------------------------------------------------------------------------
    test("Illumina Amplicon Data with Sample Name Completion") {
        tag "success"
        tag "illumina"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
                platform    = "illumina"
                primer_bed  = "${projectDir}/test_data/primer.bed"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("empty,NA,MH356245.1,No Data,2,0,15894,0.0,0.0,0.0,0,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-bcb39a9,40476,38478,275,98.27,325.34,291.0,269,")
            assert lines.contains("sample2,D8,MH356245.1,Novel-bcb39a9,56368,53533,252,98.41,456.66,456.0,273,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/amplicon.bed").exists()

            lines = path("$launchDir/results/reference/amplicon.bed").readLines()
            assert lines.contains("MH356245.1\t25\t8200\tMSV_1\t1\t+")
            assert lines.contains("MH356245.1\t8025\t15865\tMSV_2\t2\t+")
            assert lines.size() == 2

            assert path("$launchDir/results/reference/genome.bed").exists()

            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/empty.consensus.fasta").md5 == "c14c11443f08b9976164ed80339150ca"
            lines = path("$launchDir/results/consensus/empty.consensus.fasta").readLines()
            assert lines.contains(">empty MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/empty.N450.fasta").md5 == "d41d8cd98f00b204e9800998ecf8427e"

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "a305225b7f4d8b9c1dc9fffe4381cfd3"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "49dad01767d044fc73d87a6818765410"

            assert path("$launchDir/results/consensus/sample2.consensus.fasta").md5 == "277679bca761749d0ec5636f89c69e9e"
            lines = path("$launchDir/results/consensus/sample2.consensus.fasta").readLines()
            assert lines.contains(">sample2 MH356245.1")
            assert lines.contains("ACCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample2.N450.fasta").md5 == "896c7f643c3fdd5af4f0b4c8195a01df"

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 3

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/Amplicon-Summary-MultiQC-Report_multiqc_report.html").exists()
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "Amplicon-Summary-MultiQC-Report_multiqc_report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "vcf/processed_vcf/sample1.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "vcf/processed_vcf/sample2.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.N450.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "vcf/processed_vcf/empty.processed.norm.vcf.gz" }.size() == 1

            // Sample Name: empty
            assert iridanext_metadata.add_empty.genotype == "NA"
            assert iridanext_metadata.add_empty.reference == "MH356245.1"
            assert iridanext_metadata.add_empty.matched_dsid == "No Data"
            assert iridanext_metadata.add_empty.num_input_reads == "2"
            assert iridanext_metadata.add_empty.num_aligned_reads == "0"
            assert iridanext_metadata.add_empty.num_consensus_n == "15894"
            assert iridanext_metadata.add_empty.genome_completeness_percent == "0.0"
            assert iridanext_metadata.add_empty.mean_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.median_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.total_variants == "0"
            assert iridanext_metadata.add_empty.num_snps == "0"
            assert iridanext_metadata.add_empty.num_iupac == "0"
            assert iridanext_metadata.add_empty.genome_length == "15894"
            assert iridanext_metadata.add_empty.divisible_by_6 == "True"
            assert iridanext_metadata.add_empty.N450_completeness == "0.0"
            assert iridanext_metadata.add_empty.N450_mean_depth == "0.0"
            assert iridanext_metadata.add_empty.N450_status == "FAIL"
            assert iridanext_metadata.add_empty.qc_status == "INCOMPLETE_GENOME"

            // Sample Name: sample1
            assert iridanext_metadata.add_sample1.genotype == "D8"
            assert iridanext_metadata.add_sample1.reference == "MH356245.1"
            assert iridanext_metadata.add_sample1.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample1.num_input_reads == "40476"
            assert iridanext_metadata.add_sample1.num_aligned_reads == "38478"
            assert iridanext_metadata.add_sample1.num_consensus_n == "275"
            assert iridanext_metadata.add_sample1.genome_completeness_percent == "98.27"
            assert iridanext_metadata.add_sample1.mean_sequencing_depth == "325.34"
            assert iridanext_metadata.add_sample1.median_sequencing_depth == "291.0"
            assert iridanext_metadata.add_sample1.total_variants == "269"
            assert iridanext_metadata.add_sample1.num_snps == "269"
            assert iridanext_metadata.add_sample1.num_iupac == "0"
            assert iridanext_metadata.add_sample1.genome_length == "15894"
            assert iridanext_metadata.add_sample1.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample1.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample1.N450_mean_depth == "294.63"
            assert iridanext_metadata.add_sample1.N450_status == "PASS"
            assert iridanext_metadata.add_sample1.qc_status == "PASS"

            // Sample Name: sample2
            assert iridanext_metadata.add_sample2.genotype == "D8"
            assert iridanext_metadata.add_sample2.reference == "MH356245.1"
            assert iridanext_metadata.add_sample2.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample2.num_input_reads == "56368"
            assert iridanext_metadata.add_sample2.num_aligned_reads == "53533"
            assert iridanext_metadata.add_sample2.num_consensus_n == "252"
            assert iridanext_metadata.add_sample2.genome_completeness_percent == "98.41"
            assert iridanext_metadata.add_sample2.mean_sequencing_depth == "456.66"
            assert iridanext_metadata.add_sample2.median_sequencing_depth == "456.0"
            assert iridanext_metadata.add_sample2.total_variants == "273"
            assert iridanext_metadata.add_sample2.num_snps == "273"
            assert iridanext_metadata.add_sample2.num_iupac == "0"
            assert iridanext_metadata.add_sample2.genome_length == "15894"
            assert iridanext_metadata.add_sample2.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample2.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample2.N450_mean_depth == "519.54"
            assert iridanext_metadata.add_sample2.N450_status == "PASS"
            assert iridanext_metadata.add_sample2.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 6 ----------------------------------------------------------------------------
    test("Illumina Amplicon Data with Sample Name Completion with Prediction") {
        tag "success"
        tag "illumina"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                platform    = "illumina"
                amplicon    = true
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("empty,NA,MH356245.1,No Data,2,0,15894,0.0,0.0,0.0,0,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-bcb39a9,40476,38466,292,98.16,324.29,290.0,269,")
            assert lines.contains("sample2,D8,MH356245.1,Novel-bcb39a9,56368,53502,252,98.41,455.12,453.0,273,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/amplicon.bed").exists()

            lines = path("$launchDir/results/reference/amplicon.bed").readLines()
            assert lines.contains("MH356245.1\t25\t1028\tMSV_1\t5\t+")
            assert lines.contains("MH356245.1\t165\t1113\tMSV_2\t1\t+")
            assert lines.contains("MH356245.1\t1007\t1975\tMSV_3\t2\t+")
            assert lines.size() == 23

            assert path("$launchDir/results/reference/genome.bed").exists()

            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/empty.consensus.fasta").md5 == "c14c11443f08b9976164ed80339150ca"
            lines = path("$launchDir/results/consensus/empty.consensus.fasta").readLines()
            assert lines.contains(">empty MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/empty.N450.fasta").md5 == "d41d8cd98f00b204e9800998ecf8427e"

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "e52a56232c7bab03697ef5439ca48dc6"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "49dad01767d044fc73d87a6818765410"

            assert path("$launchDir/results/consensus/sample2.consensus.fasta").md5 == "277679bca761749d0ec5636f89c69e9e"
            lines = path("$launchDir/results/consensus/sample2.consensus.fasta").readLines()
            assert lines.contains(">sample2 MH356245.1")
            assert lines.contains("ACCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample2.N450.fasta").md5 == "896c7f643c3fdd5af4f0b4c8195a01df"

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 3

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/Amplicon-Summary-MultiQC-Report_multiqc_report.html").exists()
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "Amplicon-Summary-MultiQC-Report_multiqc_report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "vcf/processed_vcf/sample1.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "vcf/processed_vcf/sample2.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.N450.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "vcf/processed_vcf/empty.processed.norm.vcf.gz" }.size() == 1

            // Sample Name: empty
            assert iridanext_metadata.add_empty.genotype == "NA"
            assert iridanext_metadata.add_empty.reference == "MH356245.1"
            assert iridanext_metadata.add_empty.matched_dsid == "No Data"
            assert iridanext_metadata.add_empty.num_input_reads == "2"
            assert iridanext_metadata.add_empty.num_aligned_reads == "0"
            assert iridanext_metadata.add_empty.num_consensus_n == "15894"
            assert iridanext_metadata.add_empty.genome_completeness_percent == "0.0"
            assert iridanext_metadata.add_empty.mean_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.median_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.total_variants == "0"
            assert iridanext_metadata.add_empty.num_snps == "0"
            assert iridanext_metadata.add_empty.num_iupac == "0"
            assert iridanext_metadata.add_empty.genome_length == "15894"
            assert iridanext_metadata.add_empty.divisible_by_6 == "True"
            assert iridanext_metadata.add_empty.N450_completeness == "0.0"
            assert iridanext_metadata.add_empty.N450_mean_depth == "0.0"
            assert iridanext_metadata.add_empty.N450_status == "FAIL"
            assert iridanext_metadata.add_empty.qc_status == "INCOMPLETE_GENOME"

            // Sample Name: sample1
            assert iridanext_metadata.add_sample1.genotype == "D8"
            assert iridanext_metadata.add_sample1.reference == "MH356245.1"
            assert iridanext_metadata.add_sample1.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample1.num_input_reads == "40476"
            assert iridanext_metadata.add_sample1.num_aligned_reads == "38466"
            assert iridanext_metadata.add_sample1.num_consensus_n == "292"
            assert iridanext_metadata.add_sample1.genome_completeness_percent == "98.16"
            assert iridanext_metadata.add_sample1.mean_sequencing_depth == "324.29"
            assert iridanext_metadata.add_sample1.median_sequencing_depth == "290.0"
            assert iridanext_metadata.add_sample1.total_variants == "269"
            assert iridanext_metadata.add_sample1.num_snps == "269"
            assert iridanext_metadata.add_sample1.num_iupac == "0"
            assert iridanext_metadata.add_sample1.genome_length == "15894"
            assert iridanext_metadata.add_sample1.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample1.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample1.N450_mean_depth == "294.63"
            assert iridanext_metadata.add_sample1.N450_status == "PASS"
            assert iridanext_metadata.add_sample1.qc_status == "PASS"

            // Sample Name: sample2
            assert iridanext_metadata.add_sample2.genotype == "D8"
            assert iridanext_metadata.add_sample2.reference == "MH356245.1"
            assert iridanext_metadata.add_sample2.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample2.num_input_reads == "56368"
            assert iridanext_metadata.add_sample2.num_aligned_reads == "53502"
            assert iridanext_metadata.add_sample2.num_consensus_n == "252"
            assert iridanext_metadata.add_sample2.genome_completeness_percent == "98.41"
            assert iridanext_metadata.add_sample2.mean_sequencing_depth == "455.12"
            assert iridanext_metadata.add_sample2.median_sequencing_depth == "453.0"
            assert iridanext_metadata.add_sample2.total_variants == "273"
            assert iridanext_metadata.add_sample2.num_snps == "273"
            assert iridanext_metadata.add_sample2.num_iupac == "0"
            assert iridanext_metadata.add_sample2.genome_length == "15894"
            assert iridanext_metadata.add_sample2.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample2.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample2.N450_mean_depth == "519.54"
            assert iridanext_metadata.add_sample2.N450_status == "PASS"
            assert iridanext_metadata.add_sample2.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 7 ----------------------------------------------------------------------------
    test("Illumina NON-Amplicon Data with Sample Name Completion") {
        tag "success"
        tag "illumina"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
                platform    = "illumina"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("empty,NA,MH356245.1,No Data,2,0,15894,0.0,0.0,0.0,0,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-bcb39a9,40476,39892,214,98.65,348.6,314.0,269,")
            assert lines.contains("sample2,D8,MH356245.1,Novel-bcb39a9,56368,55680,216,98.64,491.04,491.0,273,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/genome.bed").exists()
            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/empty.consensus.fasta").md5 == "c14c11443f08b9976164ed80339150ca"
            lines = path("$launchDir/results/consensus/empty.consensus.fasta").readLines()
            assert lines.contains(">empty MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/empty.N450.fasta").md5 == "d41d8cd98f00b204e9800998ecf8427e"

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "b8a97a1eb82da0d3a54f73115cf9fdae"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "49dad01767d044fc73d87a6818765410"

            assert path("$launchDir/results/consensus/sample2.consensus.fasta").md5 == "76005b74e20868dc62c1e40d48c710e9"
            lines = path("$launchDir/results/consensus/sample2.consensus.fasta").readLines()
            assert lines.contains(">sample2 MH356245.1")
            assert lines.contains("ACCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample2.N450.fasta").md5 == "896c7f643c3fdd5af4f0b4c8195a01df"

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 3

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "vcf/processed_vcf/sample1.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "vcf/processed_vcf/sample2.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.N450.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "vcf/processed_vcf/empty.processed.norm.vcf.gz" }.size() == 1

            // Sample Name: empty
            assert iridanext_metadata.add_empty.genotype == "NA"
            assert iridanext_metadata.add_empty.reference == "MH356245.1"
            assert iridanext_metadata.add_empty.matched_dsid == "No Data"
            assert iridanext_metadata.add_empty.num_input_reads == "2"
            assert iridanext_metadata.add_empty.num_aligned_reads == "0"
            assert iridanext_metadata.add_empty.num_consensus_n == "15894"
            assert iridanext_metadata.add_empty.genome_completeness_percent == "0.0"
            assert iridanext_metadata.add_empty.mean_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.median_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.total_variants == "0"
            assert iridanext_metadata.add_empty.num_snps == "0"
            assert iridanext_metadata.add_empty.num_iupac == "0"
            assert iridanext_metadata.add_empty.genome_length == "15894"
            assert iridanext_metadata.add_empty.divisible_by_6 == "True"
            assert iridanext_metadata.add_empty.N450_completeness == "0.0"
            assert iridanext_metadata.add_empty.N450_mean_depth == "0.0"
            assert iridanext_metadata.add_empty.N450_status == "FAIL"
            assert iridanext_metadata.add_empty.qc_status == "INCOMPLETE_GENOME"

            // Sample Name: sample1
            assert iridanext_metadata.add_sample1.genotype == "D8"
            assert iridanext_metadata.add_sample1.reference == "MH356245.1"
            assert iridanext_metadata.add_sample1.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample1.num_input_reads == "40476"
            assert iridanext_metadata.add_sample1.num_aligned_reads == "39892"
            assert iridanext_metadata.add_sample1.num_consensus_n == "214"
            assert iridanext_metadata.add_sample1.genome_completeness_percent == "98.65"
            assert iridanext_metadata.add_sample1.mean_sequencing_depth == "348.6"
            assert iridanext_metadata.add_sample1.median_sequencing_depth == "314.0"
            assert iridanext_metadata.add_sample1.total_variants == "269"
            assert iridanext_metadata.add_sample1.num_snps == "269"
            assert iridanext_metadata.add_sample1.num_iupac == "0"
            assert iridanext_metadata.add_sample1.genome_length == "15894"
            assert iridanext_metadata.add_sample1.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample1.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample1.N450_mean_depth == "319.79"
            assert iridanext_metadata.add_sample1.N450_status == "PASS"
            assert iridanext_metadata.add_sample1.qc_status == "PASS"

            // Sample Name: sample2
            assert iridanext_metadata.add_sample2.genotype == "D8"
            assert iridanext_metadata.add_sample2.reference == "MH356245.1"
            assert iridanext_metadata.add_sample2.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample2.num_input_reads == "56368"
            assert iridanext_metadata.add_sample2.num_aligned_reads == "55680"
            assert iridanext_metadata.add_sample2.num_consensus_n == "216"
            assert iridanext_metadata.add_sample2.genome_completeness_percent == "98.64"
            assert iridanext_metadata.add_sample2.mean_sequencing_depth == "491.04"
            assert iridanext_metadata.add_sample2.median_sequencing_depth == "491.0"
            assert iridanext_metadata.add_sample2.total_variants == "273"
            assert iridanext_metadata.add_sample2.num_snps == "273"
            assert iridanext_metadata.add_sample2.num_iupac == "0"
            assert iridanext_metadata.add_sample2.genome_length == "15894"
            assert iridanext_metadata.add_sample2.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample2.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample2.N450_mean_depth == "560.97"
            assert iridanext_metadata.add_sample2.N450_status == "PASS"
            assert iridanext_metadata.add_sample2.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 8 ----------------------------------------------------------------------------
    test("Illumina NON-Amplicon Data with Sample Name Completion with Prediction") {
        tag "success"
        tag "illumina"

        when {
            params {
                input       = "${projectDir}/assets/ci-samplesheet.csv"
                outdir      = "results"
                platform    = "illumina"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("empty,NA,MH356245.1,No Data,2,0,15894,0.0,0.0,0.0,0,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-bcb39a9,40476,39892,214,98.65,348.6,314.0,269,")
            assert lines.contains("sample2,D8,MH356245.1,Novel-bcb39a9,56368,55680,216,98.64,491.04,491.0,273,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/genome.bed").exists()
            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/empty.consensus.fasta").md5 == "c14c11443f08b9976164ed80339150ca"
            lines = path("$launchDir/results/consensus/empty.consensus.fasta").readLines()
            assert lines.contains(">empty MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/empty.N450.fasta").md5 == "d41d8cd98f00b204e9800998ecf8427e"

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "b8a97a1eb82da0d3a54f73115cf9fdae"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "49dad01767d044fc73d87a6818765410"

            assert path("$launchDir/results/consensus/sample2.consensus.fasta").md5 == "76005b74e20868dc62c1e40d48c710e9"
            lines = path("$launchDir/results/consensus/sample2.consensus.fasta").readLines()
            assert lines.contains(">sample2 MH356245.1")
            assert lines.contains("ACCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266
            assert path("$launchDir/results/consensus/sample2.N450.fasta").md5 == "896c7f643c3fdd5af4f0b4c8195a01df"

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 3

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample1.findAll { it.path == "vcf/processed_vcf/sample1.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.N450.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "consensus/sample2.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_sample2.findAll { it.path == "vcf/processed_vcf/sample2.processed.norm.vcf.gz" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.N450.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "consensus/empty.consensus.fasta" }.size() == 1
            assert iridanext_samples.add_empty.findAll { it.path == "vcf/processed_vcf/empty.processed.norm.vcf.gz" }.size() == 1

            // Sample Name: empty
            assert iridanext_metadata.add_empty.genotype == "NA"
            assert iridanext_metadata.add_empty.reference == "MH356245.1"
            assert iridanext_metadata.add_empty.matched_dsid == "No Data"
            assert iridanext_metadata.add_empty.num_input_reads == "2"
            assert iridanext_metadata.add_empty.num_aligned_reads == "0"
            assert iridanext_metadata.add_empty.num_consensus_n == "15894"
            assert iridanext_metadata.add_empty.genome_completeness_percent == "0.0"
            assert iridanext_metadata.add_empty.mean_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.median_sequencing_depth == "0.0"
            assert iridanext_metadata.add_empty.total_variants == "0"
            assert iridanext_metadata.add_empty.num_snps == "0"
            assert iridanext_metadata.add_empty.num_iupac == "0"
            assert iridanext_metadata.add_empty.genome_length == "15894"
            assert iridanext_metadata.add_empty.divisible_by_6 == "True"
            assert iridanext_metadata.add_empty.N450_completeness == "0.0"
            assert iridanext_metadata.add_empty.N450_mean_depth == "0.0"
            assert iridanext_metadata.add_empty.N450_status == "FAIL"
            assert iridanext_metadata.add_empty.qc_status == "INCOMPLETE_GENOME"

            // Sample Name: sample1
            assert iridanext_metadata.add_sample1.genotype == "D8"
            assert iridanext_metadata.add_sample1.reference == "MH356245.1"
            assert iridanext_metadata.add_sample1.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample1.num_input_reads == "40476"
            assert iridanext_metadata.add_sample1.num_aligned_reads == "39892"
            assert iridanext_metadata.add_sample1.num_consensus_n == "214"
            assert iridanext_metadata.add_sample1.genome_completeness_percent == "98.65"
            assert iridanext_metadata.add_sample1.mean_sequencing_depth == "348.6"
            assert iridanext_metadata.add_sample1.median_sequencing_depth == "314.0"
            assert iridanext_metadata.add_sample1.total_variants == "269"
            assert iridanext_metadata.add_sample1.num_snps == "269"
            assert iridanext_metadata.add_sample1.num_iupac == "0"
            assert iridanext_metadata.add_sample1.genome_length == "15894"
            assert iridanext_metadata.add_sample1.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample1.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample1.N450_mean_depth == "319.79"
            assert iridanext_metadata.add_sample1.N450_status == "PASS"
            assert iridanext_metadata.add_sample1.qc_status == "PASS"

            // Sample Name: sample2
            assert iridanext_metadata.add_sample2.genotype == "D8"
            assert iridanext_metadata.add_sample2.reference == "MH356245.1"
            assert iridanext_metadata.add_sample2.matched_dsid == "Novel-bcb39a9"
            assert iridanext_metadata.add_sample2.num_input_reads == "56368"
            assert iridanext_metadata.add_sample2.num_aligned_reads == "55680"
            assert iridanext_metadata.add_sample2.num_consensus_n == "216"
            assert iridanext_metadata.add_sample2.genome_completeness_percent == "98.64"
            assert iridanext_metadata.add_sample2.mean_sequencing_depth == "491.04"
            assert iridanext_metadata.add_sample2.median_sequencing_depth == "491.0"
            assert iridanext_metadata.add_sample2.total_variants == "273"
            assert iridanext_metadata.add_sample2.num_snps == "273"
            assert iridanext_metadata.add_sample2.num_iupac == "0"
            assert iridanext_metadata.add_sample2.genome_length == "15894"
            assert iridanext_metadata.add_sample2.divisible_by_6 == "True"
            assert iridanext_metadata.add_sample2.N450_completeness == "100.0"
            assert iridanext_metadata.add_sample2.N450_mean_depth == "560.97"
            assert iridanext_metadata.add_sample2.N450_status == "PASS"
            assert iridanext_metadata.add_sample2.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 9 ----------------------------------------------------------------------------
    test("Nanopore NON-Amplicon Data Completion") {
        tag "success"
        tag "nanopore"

        when {
            params {
                input       = "${projectDir}/test_data/nanopore_samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
                platform    = "nanopore"
                model       = "r1041_e82_400bps_sup_v410"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-65d31ec,9368,9364,5,99.97,379.37,239.0,272,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/genome.bed").exists()
            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "dd12bca9f591597012b2a646b545bc55"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NCCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266

            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "034fe45b9902229f414548b052dda631"
            lines = path("$launchDir/results/consensus/sample1.N450.fasta").readLines()
            assert lines.contains(">sample1-N450 MH356245.1")
            assert lines.size() == 2

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 2

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "vcf/final/sample1.pass.norm.vcf.gz" }.size() == 1

            assert iridanext_metadata.sample1.genotype == "D8"
            assert iridanext_metadata.sample1.reference == "MH356245.1"
            assert iridanext_metadata.sample1.matched_dsid == "Novel-65d31ec"
            assert iridanext_metadata.sample1.num_input_reads == "9368"
            assert iridanext_metadata.sample1.num_aligned_reads == "9364"
            assert iridanext_metadata.sample1.num_consensus_n == "5"
            assert iridanext_metadata.sample1.genome_completeness_percent == "99.97"
            assert iridanext_metadata.sample1.mean_sequencing_depth == "379.37"
            assert iridanext_metadata.sample1.median_sequencing_depth == "239.0"
            assert iridanext_metadata.sample1.total_variants == "272"
            assert iridanext_metadata.sample1.num_snps == "272"
            assert iridanext_metadata.sample1.num_iupac == "0"
            assert iridanext_metadata.sample1.genome_length == "15894"
            assert iridanext_metadata.sample1.divisible_by_6 == "True"
            assert iridanext_metadata.sample1.N450_completeness == "100.0"
            assert iridanext_metadata.sample1.N450_mean_depth == "218.38"
            assert iridanext_metadata.sample1.N450_status == "PASS"
            assert iridanext_metadata.sample1.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 10 ----------------------------------------------------------------------------
    test("Nanopore NON-Amplicon Data Completion with Prediction") {
        tag "success"
        tag "nanopore"

        when {
            params {
                input       = "${projectDir}/test_data/nanopore_samplesheet.csv"
                outdir      = "results"
                platform    = "nanopore"
                model       = "r1041_e82_400bps_sup_v410"
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 10 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-65d31ec,9368,9364,5,99.97,379.37,239.0,272,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/genome.bed").exists()
            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "dd12bca9f591597012b2a646b545bc55"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NCCAAACAAAGTTGGGTAAGGATAGATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266

            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "034fe45b9902229f414548b052dda631"
            lines = path("$launchDir/results/consensus/sample1.N450.fasta").readLines()
            assert lines.contains(">sample1-N450 MH356245.1")
            assert lines.size() == 2

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 2

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "vcf/final/sample1.pass.norm.vcf.gz" }.size() == 1

            assert iridanext_metadata.sample1.genotype == "D8"
            assert iridanext_metadata.sample1.reference == "MH356245.1"
            assert iridanext_metadata.sample1.matched_dsid == "Novel-65d31ec"
            assert iridanext_metadata.sample1.num_input_reads == "9368"
            assert iridanext_metadata.sample1.num_aligned_reads == "9364"
            assert iridanext_metadata.sample1.num_consensus_n == "5"
            assert iridanext_metadata.sample1.genome_completeness_percent == "99.97"
            assert iridanext_metadata.sample1.mean_sequencing_depth == "379.37"
            assert iridanext_metadata.sample1.median_sequencing_depth == "239.0"
            assert iridanext_metadata.sample1.total_variants == "272"
            assert iridanext_metadata.sample1.num_snps == "272"
            assert iridanext_metadata.sample1.num_iupac == "0"
            assert iridanext_metadata.sample1.genome_length == "15894"
            assert iridanext_metadata.sample1.divisible_by_6 == "True"
            assert iridanext_metadata.sample1.N450_completeness == "100.0"
            assert iridanext_metadata.sample1.N450_mean_depth == "218.38"
            assert iridanext_metadata.sample1.N450_status == "PASS"
            assert iridanext_metadata.sample1.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 11 ----------------------------------------------------------------------------
    test("Nanopore Amplicon Data Completion") {
        tag "success"
        tag "nanopore"

        when {
            params {
                input       = "${projectDir}/test_data/nanopore_samplesheet.csv"
                outdir      = "results"
                reference   = "${projectDir}/assets/reference/D8/MH356245.1.reference.fasta"
                platform    = "nanopore"
                model       = "r1041_e82_400bps_sup_v410"
                primer_bed  = "${projectDir}/assets/reference/D8/primers.bed"
                min_depth   = 30
                min_variant_qual_c3 = 10
                ont_min_read_length = 400
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 11 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-65d31ec,8571,6469,1424,91.04,273.83,211.0,259,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/amplicon.bed").exists()

            lines = path("$launchDir/results/reference/amplicon.bed").readLines()
            assert lines.contains("MH356245.1\t25\t1028\tMSV_1\t5\t+")
            assert lines.contains("MH356245.1\t165\t1113\tMSV_2\t1\t+")
            assert lines.contains("MH356245.1\t1007\t1975\tMSV_3\t2\t+")
            assert lines.size() == 23

            assert path("$launchDir/results/reference/genome.bed").exists()

            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "dd056190aaa3bf9377291f3e7f171fdd"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266

            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "034fe45b9902229f414548b052dda631"
            lines = path("$launchDir/results/consensus/sample1.N450.fasta").readLines()
            assert lines.contains(">sample1-N450 MH356245.1")
            assert lines.size() == 2

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 2

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/Amplicon-Summary-MultiQC-Report_multiqc_report.html").exists()
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "Amplicon-Summary-MultiQC-Report_multiqc_report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "vcf/final/sample1.pass.norm.vcf.gz" }.size() == 1

            assert iridanext_metadata.sample1.genotype == "D8"
            assert iridanext_metadata.sample1.reference == "MH356245.1"
            assert iridanext_metadata.sample1.matched_dsid == "Novel-65d31ec"
            assert iridanext_metadata.sample1.num_input_reads == "8571"
            assert iridanext_metadata.sample1.num_aligned_reads == "6469"
            assert iridanext_metadata.sample1.num_consensus_n == "1424"
            assert iridanext_metadata.sample1.genome_completeness_percent == "91.04"
            assert iridanext_metadata.sample1.mean_sequencing_depth == "273.83"
            assert iridanext_metadata.sample1.median_sequencing_depth == "211.0"
            assert iridanext_metadata.sample1.total_variants == "259"
            assert iridanext_metadata.sample1.num_snps == "259"
            assert iridanext_metadata.sample1.num_iupac == "0"
            assert iridanext_metadata.sample1.genome_length == "15894"
            assert iridanext_metadata.sample1.divisible_by_6 == "True"
            assert iridanext_metadata.sample1.N450_completeness == "100.0"
            assert iridanext_metadata.sample1.N450_mean_depth == "214.4"
            assert iridanext_metadata.sample1.N450_status == "PASS"
            assert iridanext_metadata.sample1.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }

    //--- Test 12 ----------------------------------------------------------------------------
    test("Nanopore Amplicon Data Completion with Prediction") {
        tag "success"
        tag "nanopore"

        when {
            params {
                input       = "${projectDir}/test_data/nanopore_samplesheet.csv"
                outdir      = "results"
                platform    = "nanopore"
                model       = "r1041_e82_400bps_sup_v410"
                amplicon    = true
                min_depth   = 30
                min_variant_qual_c3 = 10
                ont_min_read_length = 400
            }
        }
        then {
            //
            // Status
            //
            assert workflow.success
            assert workflow.trace.failed().size() == 0

            //
            // Channels and Files Exist
            //
            def lines = []
            assert path("$launchDir/results").exists()

            // Final QC File
            assert path("$launchDir/results/overall.qc.csv").exists()
            // Using the first 11 columns only to get to variants count
            lines = path("$launchDir/results/overall.qc.csv").text
            assert lines.contains("sample,genotype,reference,matched_dsid,num_input_reads,num_aligned_reads,num_consensus_n,genome_completeness_percent,mean_sequencing_depth,median_sequencing_depth,total_variants,")
            assert lines.contains("sample1,D8,MH356245.1,Novel-65d31ec,8571,6469,1424,91.04,273.83,211.0,259,")

            // Intermediate generated reference files
            assert path("$launchDir/results/reference/amplicon.bed").exists()

            lines = path("$launchDir/results/reference/amplicon.bed").readLines()
            assert lines.contains("MH356245.1\t25\t1028\tMSV_1\t5\t+")
            assert lines.contains("MH356245.1\t165\t1113\tMSV_2\t1\t+")
            assert lines.contains("MH356245.1\t1007\t1975\tMSV_3\t2\t+")
            assert lines.size() == 23

            assert path("$launchDir/results/reference/genome.bed").exists()

            lines = path("$launchDir/results/reference/genome.bed").text
            assert lines.contains("MH356245.1\t0\t15894")

            // Sample Outputs
            //  Fasta regions match
            assert path("$launchDir/results/consensus/MH356245.1.N450.fasta").md5 == "79e89ca9bfb7213c3767b2011f9ffee8"
            lines = path("$launchDir/results/consensus/MH356245.1.N450.fasta").readLines()
            assert lines.contains(">MH356245.1-N450 ")
            assert lines.size() == 2

            assert path("$launchDir/results/consensus/sample1.consensus.fasta").md5 == "dd056190aaa3bf9377291f3e7f171fdd"
            lines = path("$launchDir/results/consensus/sample1.consensus.fasta").readLines()
            assert lines.contains(">sample1 MH356245.1")
            assert lines.contains("NNNNNNNNNNNNNNNNNNNNNNNNNATCAATCAATGATCATATTCTAGTACACTTAGGAT")
            assert lines.size() == 266

            assert path("$launchDir/results/consensus/sample1.N450.fasta").md5 == "034fe45b9902229f414548b052dda631"
            lines = path("$launchDir/results/consensus/sample1.N450.fasta").readLines()
            assert lines.contains(">sample1-N450 MH356245.1")
            assert lines.size() == 2

            //  Reporting files
            assert path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth.csv").readLines()
            assert lines.size() == 2

            assert path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").exists()
            lines = path("$launchDir/results/reporting/sample_positional_normalized_depth_stats.csv").readLines()
            assert lines.size() == 15895

            // Final Reports
            assert path("$launchDir/results/Amplicon-Summary-MultiQC-Report_multiqc_report.html").exists()
            assert path("$launchDir/results/MeaSeq_Report.html").exists()
            assert path("$launchDir/results/overall.xlsx").exists()
            assert path("$launchDir/results/dsids.tsv").exists()

            // IRIDA Next output
            def iridanext_json = path("$launchDir/results/iridanext.output.json").json
            def iridanext_global = iridanext_json.files.global
            def iridanext_samples = iridanext_json.files.samples
            def iridanext_metadata = iridanext_json.metadata.samples

            assert iridanext_global.findAll { it.path == "Amplicon-Summary-MultiQC-Report_multiqc_report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "MeaSeq_Report.html" }.size() == 1
            assert iridanext_global.findAll { it.path == "pipeline_info/measeq_software_mqc_versions.yml" }.size() == 1
            assert iridanext_global.findAll { it.path == "overall.xlsx" }.size() == 1
            assert iridanext_global.findAll { it.path == "novel_dsids.tsv" }.size() == 1

            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.N450.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "consensus/sample1.consensus.fasta" }.size() == 1
            assert iridanext_samples.sample1.findAll { it.path == "vcf/final/sample1.pass.norm.vcf.gz" }.size() == 1

            assert iridanext_metadata.sample1.genotype == "D8"
            assert iridanext_metadata.sample1.reference == "MH356245.1"
            assert iridanext_metadata.sample1.matched_dsid == "Novel-65d31ec"
            assert iridanext_metadata.sample1.num_input_reads == "8571"
            assert iridanext_metadata.sample1.num_aligned_reads == "6469"
            assert iridanext_metadata.sample1.num_consensus_n == "1424"
            assert iridanext_metadata.sample1.genome_completeness_percent == "91.04"
            assert iridanext_metadata.sample1.mean_sequencing_depth == "273.83"
            assert iridanext_metadata.sample1.median_sequencing_depth == "211.0"
            assert iridanext_metadata.sample1.total_variants == "259"
            assert iridanext_metadata.sample1.num_snps == "259"
            assert iridanext_metadata.sample1.num_iupac == "0"
            assert iridanext_metadata.sample1.genome_length == "15894"
            assert iridanext_metadata.sample1.divisible_by_6 == "True"
            assert iridanext_metadata.sample1.N450_completeness == "100.0"
            assert iridanext_metadata.sample1.N450_mean_depth == "214.4"
            assert iridanext_metadata.sample1.N450_status == "PASS"
            assert iridanext_metadata.sample1.qc_status == "PASS"

            // Pipeline info and tracking
            assert path("$launchDir/results/pipeline_info").exists()
            assert path("$launchDir/results/pipeline_info/measeq_software_mqc_versions.yml").exists()
        }
    }
}
